---
title: 'Data analysis and graphics for: The costs and benefits of publicising species
  discoveries.'
author: "GE Ryan"
output:
  html_notebook: default
  pdf_document: default
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r packages}
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)
library(readxl)
library(viridis)
library(patchwork)
library(magrittr)
library(purrr)
library(extraDistr)
```

```{r source functions}
source("functions/calculate.zeta.R")
source("functions/find.b.R")
source("functions/find.lambda.R")
source("functions/find.sigma.R")
source("functions/sample.fun.R")
```


# Example scenarios

Load data
```{r load example}
example_data <- readxl::read_xlsx(
  path = "data/species_publicity_data.xlsx",
  sheet = "example_case_studies"
)

example_data
```
Calculate decision score, zeta, for each option
```{r example_results}
example_results <- example_data %>%
  as_tibble %>%
  mutate(
    zeta = benefit - cost - probability_of_leaking*(cost_of_publicity - cost),
    involve = factor(
      involve,
      levels = c(
        "Government",
        "Local community group",
        "Public"
      )
    ),
    disclose = factor(
      disclose,
      levels = c(
        "Nothing",
        "Province",
        "Protected area",
        "Exact location"
      ),
    ),
    disclose = recode(
      disclose,
      "Protected area" = "Protected\narea",
      "Exact location" = "Exact\nlocation"
    )
  ) %>%
  group_by(species) %>%
  mutate(
    maxval = max(zeta)
  ) %>%
  ungroup %>%
  mutate(
    optimal = ifelse(
      zeta == maxval,
      "optimal",
      "not optimal"
    )
  ) %>%
  select(-maxval)

example_results
```

Plot results from examples scenarios in figure 1.
```{r figure_1}
figure_1 <- ggplot(example_results) +
  geom_hline(
    yintercept = 0,
    colour = "darkgrey"
  ) +
  geom_point(
    aes(
      x = disclose,
      y = zeta,
      colour = involve,
      shape = optimal,
      size = optimal
    ),
    position = position_dodge(
      width = 0.1)
  ) +
  facet_wrap(
    facets = ~ species,
    nrow = 2,
    scales = "free_y"
  ) +
  theme_grey() +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.title.y = element_text(
      angle = 0
    ),
    axis.text.x = element_text(
      angle = 90
    )#,
    #legend.position = "bottom"
  ) +
  ylab("Decision\nscore") +
  xlab("Decision to disclose") +
  scale_colour_manual(
    values = plasma(11)[c(2,6,10)],
    guide = guide_legend(
      title = "Decision to\ninvolve",
      direction = "vertical"
    )
  ) +
  scale_shape_manual(
    values = c(19, 17),
    guide = guide_legend(
      title = "Decision is\noptimal?",
      direction = "vertical"
    )
  ) +
  scale_size_manual(
    values = c(4, 5),
    guide = guide_legend(
      title = "Decision is\noptimal?",
      direction = "vertical"
    )
  ) 

figure_1
```

```{r figure_1 png}
png(
  filename = "plots/figure_1.png",
  width = 20,
  height = 12.5,
  units = "cm",
  res = 300
)
figure_1
dev.off()
```


```{r table_s2}
table_s2 <- example_results %>%
  select(species, disclose, involve, zeta) %>% 
  pivot_wider(
    names_from = disclose,
    values_from = zeta
  ) %>%
  arrange(species, involve)

table_s2
```

```{r write_table_s2}
write.csv(
  x = table_s2,
  file = "output/table_s2.csv",
  row.names = FALSE
)
```

# Questionnaire numeric estimates of cost and benefits
Read in numeric questionnaire data
```{r numeric_data}
numeric_data <- readxl::read_xlsx(
  path = "data/species_publicity_data.xlsx",
  sheet = "questionnaire_numeric"
)


numeric_data[ , which(substr(colnames(numeric_data), 1,1) == "q")] <- apply(
  X = numeric_data[ , which(substr(colnames(numeric_data), 1,1) == "q")],
  MARGIN = 2,
  FUN = as.numeric
)

numeric_data
```

Transform to long format and tidy
```{r numdat}
numdat <- numeric_data %>%
  select(
    -status,
    -currency,
    -consent_sp_id,
    -consent_sp_loc,
    -sp_loc
  ) %>%
  pivot_longer(
    cols = starts_with("q"),
    names_to = "question",
  ) %>%
  mutate(
    decision = substr(
      x = question,
      start = 2,
      stop = 2
    ) %>%
      as.integer,
    type = substr(
      x = question,
      start = 4,
      stop = 4
    ) %>%
      as.integer,
    estimate = substr(
      x = question,
      start = 6,
      stop = 6
    ) %>%
      as.integer
  ) %>%
  mutate(
    decision = case_when(
      decision == 1 ~ "Public",
      decision == 2 ~ "Part",
      decision == 3 ~ "Secret"
    ),
    decision = factor(
      x = decision,
      levels = c(
        "Public",
        "Part",
        "Secret"
      )
    ),
    type = case_when(
      type == 1 ~ "Benefit",
      type == 2 ~ "Cost",
      type == 3 ~ "pd"
    ),
    estimate = case_when(
      estimate == 1 ~ "lower",
      estimate == 2 ~ "upper",
      estimate == 3 ~ "most.likely",
      estimate == 4 ~ "pconf"
    )
  ) %>%
  select(
    species,
    decision,
    type,
    estimate,
    value
  ) %>%
  filter(
    species != "Species2"
  )

numdat
```

Separate out cost and benefit data, widen format, and determine type of distribution to be fit to estimates
```{r cost_benefit}
cost_benefit <- numdat %>%
  filter(type != "pd") %>%
  pivot_wider(
    names_from = estimate,
    values_from = value
  ) %>%
  mutate(
    pconf = pconf/100
  ) %>%
  filter(species != "Species2") %>%
  mutate(
    most.likely = ifelse(
      test = is.na(most.likely),
      yes = (upper - lower)/2,
      no = most.likely
    ),
    pconf = ifelse(
      test = is.na(pconf),
      yes = 0.95,
      no = pconf
    ),
    dist = case_when(
      pconf == 1 ~ "triangular",
      lower == most.likely & lower != 0 & pconf > 0.5 ~ "triangular",
      lower == most.likely ~ "exponential",
      TRUE ~ "lognormal"
    )
  )


cost_benefit
```

Estimate parameters for lognormal distributions
```{r cb_ln}
cost_benefit_lognormal <- cost_benefit %>%
  filter(dist == "lognormal") %>%
  mutate(
    value = pmap(
      .l = list(
        lower = lower,
        most.likely = most.likely,
        upper = upper,
        p = pconf
      ),
      .f = find.sigma,
      print.sigma = FALSE
    )
  ) %>%
  unnest(value)

cost_benefit_lognormal
```

Estimate parameters for exponential distributions
```{r cb_ex}
cost_benefit_exponential <- cost_benefit %>%
  filter(dist == "exponential") %>%
  mutate(
    value = pmap(
      .l = list(
        lower = lower,
        upper = upper,
        p = pconf
      ),
      .f = find.lambda,
    )
  ) %>%
  unnest(value)

cost_benefit_exponential
```

Estimate parameters for triangular distributions
```{r cb_tr}
cost_benefit_triangular <- cost_benefit %>%
  filter(dist == "triangular") %>%
  mutate(
    value = pmap(
      .l = list(
        lower = lower,
        most.likely = most.likely,
        upper = upper,
        p = pconf
      ),
      .f = find.b,
    )
  ) %>%
  unnest(value)

cost_benefit_triangular
```

Number of random samples to take from distributions
```{r nsamples}
nsamples <- 1000
```

Bind cost benefit data data back together and sample distributions for each variable
```{r cb_all}
cost_benefit_all <- bind_rows(
  cost_benefit_lognormal,
  cost_benefit_exponential,
  cost_benefit_triangular
) %>%
   mutate(
    samples = pmap(
      .l = list(
        dist = dist,
        most.likely = most.likely,
        value = value
      ),
      .f = sample.fun,
      n = nsamples
    )
  ) 

cost_benefit_all
```

Table s3. Generate table of statistical distributions and parameters used for sampling
```{r table_s3}
distribution_table <- cost_benefit_all %>%
  select(
    species,
    decision,
    type,
    lower,
    most.likely,
    everything(),
    -samples
  ) %>%
  mutate(
    sigma = ifelse(
      dist == "lognormal",
      value,
      NA
    ),
    mu = ifelse(
      dist == "lognormal",
      log(most.likely) + sigma^2,
      NA
    ),
    lambda = ifelse(
      dist == "exponential",
      value,
      NA
    ),
    a = ifelse(
      dist == "triangular",
      0,
      NA
    ),
    b = ifelse(
      dist == "triangular",
      value,
      NA
    ),
    c = ifelse(
      dist == "triangular",
      most.likely,
      NA
    )
  ) %>%
  select(
    -value
  ) %>%
  arrange(species, decision, type)

distribution_table
```

Write out table s2
```{r write_table_s3}
write.csv(
  x = distribution_table,
  file = "output/table_s3.csv",
  row.names = FALSE
)
```

Probability information becomes public given a decision, pd.
```{r pd}
pd_all <- numdat %>%
  filter(type == "pd") %>%
  mutate(
    pd = value/100
  ) %>%
  select(
    species,
    decision,
    pd
  )

pd_all
```

Cost if a decision is public, Cp
```{r cp}
cost_public <- cost_benefit_all %>%
  filter(decision == "Public") %>%
  filter(type == "Cost") %>%
  select(
    species,
    Cost_public = samples
  )

cost_public
```

Calculate estimates of decision score zeta from samples
```{r zeta_estimates}
zeta_estimates <- cost_benefit_all %>%
  pivot_wider(
    id_cols = c(
      species, decision
    ),
    names_from = type,
    values_from = samples
  ) %>%
  arrange(
    species, decision
  ) %>%
  full_join(
    cost_public
  ) %>%
  full_join(
    pd_all
  ) %>%
  mutate(
    pd = ifelse(
      test = is.na(pd),
      yes = 1,
      pd
    )
  ) %>%
  mutate(
    id = list(1:nsamples)
  ) %>%
  unnest(
    cols = c(
      Benefit,
      Cost,
      Cost_public,
      id
    )
  ) %>%
  mutate(
    zeta = pmap(
      .l = list(
        Bd = Benefit,
        Cd = Cost,
        pd = pd,
        Cp = Cost_public
      ),
      .f = calculate.zeta
    )
  ) %>%
  unnest(zeta) 

zeta_estimates
```


Calculate the upper and lower bounds for plotting as for each species the highest of the 97.5th percentile decision score for each decision and lowest of the 2.5th percentile for each decision.
```{r}
zeta_estimates_limits <- zeta_estimates %>%
  group_by(species, decision) %>%
  summarise(
    p2.5 = quantile(
      x = zeta,
      probs = 0.025
    ),
    p97.5 = quantile(
      x = zeta,
      probs = 0.975
    )
  ) %>%
  group_by(species) %>%
  summarise(
    lower = min(p2.5),
    upper = max(p97.5)
  )

zeta_estimates_limits
```

Plot results
```{r fig2_list}

fig2_v_list <- lapply(
  X = unique(zeta_estimates$species),
  FUN = plot_fun_fig_2_violin,
  data = zeta_estimates,
  limits = zeta_estimates_limits,
  xlab = FALSE,
  ylab = FALSE
)

fig2_b_list <- lapply(
  X = unique(zeta_estimates$species),
  FUN = plot_fun_fig_2_box,
  data = zeta_estimates,
  limits = zeta_estimates_limits,
  xlab = FALSE,
  ylab = FALSE
)
```

```{r}
figure_2_v <- fig2_v_list[[1]] +
  fig2_v_list[[2]] +
  fig2_v_list[[3]] +
  fig2_v_list[[4]] +
  fig2_v_list[[5]] +
  fig2_v_list[[6]] +
  fig2_v_list[[7]] +
  guide_area() +
  plot_layout(ncol = 4) +
  plot_layout(guides = "collect")


figure_2_v
```


```{r}
ggplot(zeta_estimates) +
  geom_violin(
    aes(
      x = decision,
      y = zeta,
      fill = decision
    )#,
    #draw_quantiles = c(0.25, 0.5, 0.75)
  ) +
  #geom_boxplot(aes(x = decision, y = zeta)) +
  facet_wrap(
    facets = ~ species,
    nrow = 2,
    scales = "free_y"
  ) +
  geom_hline(
    yintercept = 0,
    colour = "darkgrey"
  ) +
  ylab("Decision\nscore") +
  xlab("Decision to disclose") +
  scale_fill_manual(
    values = viridis(3)[3:1],
    guide = guide_legend(
      title = "Decision\nto disclose",
      direction = "vertical"
    ) 
  ) +
  theme(
    axis.text.x = element_text(
      angle = 270
    )
  )
  
```
```{r}
ggplot(mtcars) +
  geom_violin(
    aes(x = factor(cyl),
        y = mpg)
  ) +
  facet_wrap(
    facets = ~ vs,
    scales = "free_y"
  ) +
  lims(y = c(10, 15, 15, 20))
  
```


```{r}
ggplot(zeta_estimates) +
  # geom_violin(
  #   aes(
  #     x = decision,
  #     y = zeta,
  #     fill = decision
  #   )#,
  #   #draw_quantiles = c(0.25, 0.5, 0.75)
  # ) +
  geom_boxplot(
    aes(
      x = decision,
      y = zeta,
      fill = decision
    ),
    outlier.size = 0.5
  ) +
  facet_wrap(
    facets = ~ species,
    nrow = 2,
    scales = "free_y"
  ) +
  geom_hline(
    yintercept = 0,
    colour = "darkgrey"
  ) +
  ylab("Decision\nscore") +
  xlab("Decision to disclose") +
  scale_fill_manual(
    values = viridis(3)[3:1],
    guide = guide_legend(
      title = "Decision\nto disclose",
      direction = "vertical"
    ) 
  ) +
  theme(
    axis.text.x = element_text(
      angle = 270
    )
  )
```

```{r}
aa <- plot_fun_fig_1_violin(
  data = zeta_estimates,
  species = "Giant Ibis"#,
  #limits = zeta_estimates_95
)

aa
```


```{r}
best_option <- zeta_estimates %>%
  pivot_wider(
    id_cols = c(
      species,
      id
    ),
    names_from = decision,
    values_from = zeta
  ) %>%
  select(
    species, id, Public, Part, Secret
  ) %>%
  rowwise %>%
  mutate(
    zetamax = max(Public, Part, Secret),
    best = case_when(
      zetamax == Public ~ "Public",
      zetamax == Part ~ "Part",
      zetamax == Secret ~ "Secret"
    )
  ) %>%
  ungroup %>%
  mutate(
    max_positive = ifelse(
      test = zetamax > 1,
      yes = 1,
      no = 0
    ),
    pub_positive = ifelse(
      test = Public > 1,
      yes = 1,
      no = 0
    ),
    par_positive = ifelse(
      test = Part > 1,
      yes = 1,
      no = 0
    ),
    sec_positive = ifelse(
      test = Secret > 1,
      yes = 1,
      no = 0
    )
  )
  

best_option
```


```{r}
best_option_plot <- best_option %>%
  group_by(species, best) %>%
  summarise(n = n()) %>%
  mutate(
    prop.best = n/1000,
    best = factor(
      x = best,
      levels = c(
        "Public",
        "Part",
        "Secret"
      )
    )
  )

best_option_plot
```

```{r}
ggplot(best_option_plot) +
  geom_bar(
    aes(
      x = species,
      y = prop.best,
      fill = best
    ),
    position = "stack",
    stat = "identity"
  ) +
  ylab("Proportion of times decision best") +
  xlab("Species") +
  scale_fill_manual(
    values = viridis(3)[3:1],
    guide = guide_legend(
      title = "Decision\nto disclose",
      direction = "vertical"
    ) 
  ) +
  ylim(c(0,1)) +
  theme(
    axis.text.x = element_text(
      angle = 270
    )
  )
```



```{r}
best_option_table <-  best_option_plot %>%
  pivot_wider(
    id_cols = species,
    names_from = best,
    values_from = prop.best
  ) %>%
  select(
    species,
    Public,
    Part,
    Secret
  )

best_option_table
```


```{r}
net_benefit_table <- best_option %>%
  group_by(
    species
  ) %>%
  summarise(
    p_max_positive = sum(max_positive)/1000,
    p_pub_positive = sum(pub_positive)/1000,
    p_par_positive = sum(par_positive)/1000,
    p_sec_positive = sum(sec_positive)/1000
  )

net_benefit_table
```


```{r}
net_benefit_plot <- net_benefit_table %>%
  pivot_longer(
    cols = -species,
    names_to = "Decision",
    values_to = "Proportion positive"
  ) %>%
  mutate(
    Decision = recode(
      Decision,
      p_max_positive = "Best",
      p_pub_positive = "Public",
      p_par_positive = "Part",
      p_sec_positive = "Secret"
    ),
    Decision = factor(
      x = Decision,
      levels = c(
        "Best",
        "Public",
        "Part",
        "Secret"
      )
    )
  )

net_benefit_plot
```

```{r}
ggplot(net_benefit_plot) +
  geom_bar(
    aes(
      x = Decision,
      y = `Proportion positive`,
      fill = Decision
    ),
    stat = "identity"
  ) + 
  facet_wrap(
    facets = ~ species,
    nrow = 2
  ) +
  ylab("Proportion of times decision results in net benefit") +
  xlab("Decision to disclose") +
  scale_fill_manual(
    values = c("darkgrey", viridis(3)[3:1]),
    guide = guide_legend(
      title = "Decision\nto disclose",
      direction = "vertical"
    ) 
  ) +
  theme(
    axis.text.x = element_text(
      angle = 270
    )
  )
  ylim(c(0,1))
```




# Questionnaire written responses on types of costs and benefits
```{r text_dat}
text_dat <- readxl::read_xlsx(
  path = "data/species_publicity_data.xlsx",
  sheet = "questionnaire_text"
)
```

```{r }
q_numeric <- sapply(text_dat, is.numeric)
sum_resp <- sapply(
  X = text_dat,
  FUN = function(x){
    
    isnum <- is.numeric(x)
    
    if(isnum){
      result <- sum(x, na.rm = TRUE)
    } else {
      result <- NA
    }
    
  }
)

perc_resp <- sapply(
  X = text_dat,
  FUN = function(x){
    
    isnum <- is.numeric(x)
    
    lenx <- length(x)
    
    if(isnum){
      result <- 100*sum(x, na.rm = TRUE)/lenx
    } else {
      result <- NA
    }
    
  }
)

text_results <- tibble(
  question = colnames(text_dat),
  sum_responses = sum_resp,
  percentage_responses = perc_resp
)

text_results
```

```{r}
all_results <- text_results %>%
  filter(substr(question, 1, 3) == "all") %>%
  mutate(
    c1 = sub(
      pattern = ".{0,4}_",
      replacement = "",
      question
    ),
    c2 = sub(
      pattern = ".{0,8}_",
      replacement = "",
      c1
    ),
    cost_benefit= sub(
      pattern = "_.*",
      replacement = "",
      c1
    ),
    group = sub(
      pattern = "_.*",
      replacement = "",
      c2
    ),
    response = sub(
      pattern = ".{0,8}_",
      replacement = "",
      c2
    )
  ) %>%
  select(cost_benefit, group, response, sum_responses, percentage_responses) %>%
  mutate(
    response = recode(
      response,
      "funding" = "Funding",
      "awareness-publicsupport" = "Awareness &\npublic support",
      "protection-recovery" = "Protection &\nrecovery",
      "species" = "Species",
      "individuals" = "Individual\npeople",
      "researchersandinstitutes" = "Researchers &\ninstitutes",
      "gov" = "Government",
      "business" = "Business",
      "ngo" = "NGOs",
      "genpublic" = "General\npublic",
      "genpub" = "General\npublic",
      "poaching" = "Poaching",
      "extinctionextirpation" = "Extinction &\nextirpation",
      "disease" = "Disease",
      "funding-financial" = "Funding",
      "reputation" = "Reputation"
    )
  )

all_results
```


```{r}
benefits <- all_results %>% filter(cost_benefit == "benefits")
costs <- all_results %>% filter(cost_benefit == "costs")

benefits_kind     <- benefits %>% filter(group == "kind")
benefits_entities <- benefits %>% filter(group == "entities")
benefits_source   <- benefits %>% filter(group == "source")

costs_kind     <- costs %>% filter(group == "kind")
costs_entities <- costs %>% filter(group == "entities")
```


```{r}
figure_3a <- ggplot(benefits_kind) +
  geom_bar(
    aes(
      x = response,
      y = percentage_responses
    ),
    fill = viridis(9)[8],
    stat = "identity",
    width = 0.9*3/7
  ) +
  ylab("Percentage of informants") +
  xlab("Kinds of benefit") +
  ylim(0, 100) +
  coord_flip()

figure_3a
```

```{r}
figure_3b <- ggplot(benefits_entities) +
  geom_bar(
    aes(
      x = response,
      y = percentage_responses
    ),
    fill = viridis(9)[8],
    stat = "identity",
    width = 0.9
  ) +
  ylab("Percentage of informants") +
  xlab("Entities\nrecieving benefits") +
  ylim(0, 100) +
  theme(
    axis.text.y = element_text(
      size = 7,
      lineheight = 0.7
    )
  )+
  coord_flip()

figure_3b
```

```{r}
figure_3c <- ggplot(benefits_source) +
  geom_bar(
    aes(
      x = response,
      y = percentage_responses
    ),
    fill = viridis(9)[8],
    stat = "identity",
    width = 0.9*3/7
  ) +
  ylab("Percentage of informants") +
  xlab("Source of benefits") +
  ylim(0, 100) +
  coord_flip()

figure_3c
```

```{r}
figure_3d <- ggplot(costs_kind) +
  geom_bar(
    aes(
      x = response,
      y = percentage_responses
    ),
    fill = viridis(9)[2],
    stat = "identity",
    width = 0.9*5/7
  ) +
  ylab("Percentage of informants") +
  xlab("Kinds of cost") +
  ylim(0, 100) +
  theme(
    axis.text.y = element_text(
      lineheight = 0.7
    )
  ) +
  coord_flip()

figure_3d
```

```{r}
figure_3e <- ggplot(costs_entities) +
  geom_bar(
    aes(
      x = response,
      y = percentage_responses
    ),
    fill = viridis(9)[2],
    stat = "identity",
    width = 0.9*3/7
  ) +
  ylab("Percentage of informants") +
  xlab("Entities\nbearing costs") +
  ylim(0, 100) +
  coord_flip()

figure_3e
```

```{r}
figure_3 <- figure_3a +
  figure_3d +
  figure_3b +
  figure_3e +
  figure_3c +
  plot_layout(
    ncol = 2
  ) +
  plot_annotation(
    tag_levels = "a"
  )

figure_3
```

```{r}
png(
  filename = "plots/figure_3.png",
  width = 20,
  height = 12.5,
  units = "cm",
  res = 300
)
figure_3
dev.off()
```

